<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - AI Camera v1.3</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-feed {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Remove old overlay controls */
        .camera-controls {
            display: none; /* Hide old overlay controls */
        }
        
        /* New controls above video frame */
        .camera-controls-above {
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .control-btn {
            min-width: 80px;
            font-size: 0.875rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        
        .config-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
        }
        
        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="/">
                            <i class="fas fa-camera"></i> AI Camera v1.3
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                            <a class="nav-link active" href="/camera"><i class="fas fa-video"></i> Camera</a>
                            <a class="nav-link" href="/health"><i class="fas fa-heartbeat"></i> Health</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Video Stream -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-video"></i> Live Camera Feed
                            <span id="camera-status" class="status-indicator status-offline"></span>
                            <span id="camera-status-text">Offline</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Camera Control Buttons - Moved above video frame -->
                        <div class="camera-controls-above mb-2 p-2 bg-light border-bottom">
                            <div class="d-flex justify-content-center gap-2">
                                <button id="start-btn" class="btn btn-success btn-sm control-btn">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button id="stop-btn" class="btn btn-danger btn-sm control-btn">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                                <button id="restart-btn" class="btn btn-warning btn-sm control-btn">
                                    <i class="fas fa-redo"></i> Restart
                                </button>
                                <button id="capture-btn" class="btn btn-info btn-sm control-btn">
                                    <i class="fas fa-camera"></i> Capture
                                </button>
                            </div>
                        </div>
                        
                        <!-- Video Container -->
                        <div class="video-container">
                            <img id="video-feed" src="/camera/video_feed" class="video-feed" alt="Camera Feed">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Controls -->
            <div class="col-lg-4">
                <!-- Status Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-info-circle"></i> Camera Status
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="status-content">
                            <p class="text-muted">Loading status...</p>
                        </div>
                    </div>
                </div>

                <!-- Configuration Form -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-cog"></i> Camera Configuration
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="config-form">
                            <div class="mb-3">
                                <label for="resolution" class="form-label">Resolution</label>
                                <select class="form-select" id="resolution" name="resolution">
                                    <option value="(1280, 720)">1280x720 (HD)</option>
                                    <option value="(1920, 1080)">1920x1080 (Full HD)</option>
                                    <option value="(640, 480)">640x480 (VGA)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="framerate" class="form-label">Frame Rate</label>
                                <input type="range" class="form-range" id="framerate" name="framerate" 
                                       min="1" max="60" value="30">
                                <div class="form-text">Current: <span id="framerate-value">30</span> FPS</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="brightness" class="form-label">Brightness</label>
                                <input type="range" class="form-range" id="brightness" name="brightness" 
                                       min="-1" max="1" step="0.1" value="0">
                                <div class="form-text">Current: <span id="brightness-value">0</span></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="contrast" class="form-label">Contrast</label>
                                <input type="range" class="form-range" id="contrast" name="contrast" 
                                       min="0" max="2" step="0.1" value="1">
                                <div class="form-text">Current: <span id="contrast-value">1</span></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="saturation" class="form-label">Saturation</label>
                                <input type="range" class="form-range" id="saturation" name="saturation" 
                                       min="0" max="2" step="0.1" value="1">
                                <div class="form-text">Current: <span id="saturation-value">1</span></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="awb_mode" class="form-label">White Balance</label>
                                <select class="form-select" id="awb_mode" name="awb_mode">
                                    <option value="auto">Auto</option>
                                    <option value="fluorescent">Fluorescent</option>
                                    <option value="incandescent">Incandescent</option>
                                    <option value="tungsten">Tungsten</option>
                                    <option value="horizon">Horizon</option>
                                    <option value="daylight">Daylight</option>
                                    <option value="cloudy">Cloudy</option>
                                    <option value="shade">Shade</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save"></i> Update Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <!-- System Logs -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-terminal"></i> System Logs
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize Socket.IO
        const socket = io('/camera');
        
        // DOM elements
        const videoFeed = document.getElementById('video-feed');
        const cameraStatus = document.getElementById('camera-status');
        const cameraStatusText = document.getElementById('camera-status-text');
        const statusContent = document.getElementById('status-content');
        const logContainer = document.getElementById('log-container');
        const configForm = document.getElementById('config-form');
        
        // Control buttons
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const restartBtn = document.getElementById('restart-btn');
        const captureBtn = document.getElementById('capture-btn');
        
        // Configuration form elements
        const framerateSlider = document.getElementById('framerate');
        const framerateValue = document.getElementById('framerate-value');
        const brightnessSlider = document.getElementById('brightness');
        const brightnessValue = document.getElementById('brightness-value');
        const contrastSlider = document.getElementById('contrast');
        const contrastValue = document.getElementById('contrast-value');
        const saturationSlider = document.getElementById('saturation');
        const saturationValue = document.getElementById('saturation-value');
        
        // Log function
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Update status display
        function updateStatus(status) {
            if (status.streaming) {
                cameraStatus.className = 'status-indicator status-online';
                cameraStatusText.textContent = 'Online';
            } else if (status.initialized) {
                cameraStatus.className = 'status-indicator status-warning';
                cameraStatusText.textContent = 'Ready';
            } else {
                cameraStatus.className = 'status-indicator status-offline';
                cameraStatusText.textContent = 'Offline';
            }
            
            // Update status content
            let statusHtml = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Initialized:</small><br>
                        <strong>${status.initialized ? 'Yes' : 'No'}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Streaming:</small><br>
                        <strong>${status.streaming ? 'Yes' : 'No'}</strong>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Frame Count:</small><br>
                        <strong>${status.frame_count || 0}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Avg FPS:</small><br>
                        <strong>${status.average_fps ? status.average_fps.toFixed(1) : '0'}</strong>
                    </div>
                </div>
            `;
            
            if (status.uptime) {
                statusHtml += `
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">Uptime:</small><br>
                            <strong>${Math.floor(status.uptime / 60)}m ${Math.floor(status.uptime % 60)}s</strong>
                        </div>
                    </div>
                `;
            }
            
            statusContent.innerHTML = statusHtml;
        }
        
        // Update configuration form
        function updateConfigForm(config) {
            if (config.resolution) {
                document.getElementById('resolution').value = `(${config.resolution[0]}, ${config.resolution[1]})`;
            }
            if (config.framerate) {
                framerateSlider.value = config.framerate;
                framerateValue.textContent = config.framerate;
            }
            if (config.brightness !== undefined) {
                brightnessSlider.value = config.brightness;
                brightnessValue.textContent = config.brightness;
            }
            if (config.contrast !== undefined) {
                contrastSlider.value = config.contrast;
                contrastValue.textContent = config.contrast;
            }
            if (config.saturation !== undefined) {
                saturationSlider.value = config.saturation;
                saturationValue.textContent = config.saturation;
            }
            if (config.awb_mode) {
                document.getElementById('awb_mode').value = config.awb_mode;
            }
        }
        
        // Socket.IO event handlers
        socket.on('connect', function() {
            addLog('Connected to camera service', 'success');
            socket.emit('camera_status_request');
        });
        
        socket.on('disconnect', function() {
            addLog('Disconnected from camera service', 'error');
        });
        
        socket.on('camera_status_update', function(status) {
            updateStatus(status);
            if (status.config) {
                updateConfigForm(status.config);
            }
        });
        
        socket.on('camera_control_response', function(response) {
            let message;
            if (response.success) {
                message = response.message || 'Command executed successfully';
            } else {
                message = response.error || response.message || 'Command failed';
            }
            addLog(`Camera control: ${message}`, response.success ? 'success' : 'error');
        });
        
        socket.on('camera_config_response', function(response) {
            let message;
            if (response.success) {
                message = response.message || 'Configuration updated successfully';
            } else {
                message = response.error || 'Configuration update failed';
            }
            addLog(`Configuration: ${message}`, response.success ? 'success' : 'error');
        });
        
        // Control button event handlers
        startBtn.addEventListener('click', function() {
            socket.emit('camera_control', {command: 'start'});
        });
        
        stopBtn.addEventListener('click', function() {
            socket.emit('camera_control', {command: 'stop'});
        });
        
        restartBtn.addEventListener('click', function() {
            socket.emit('camera_control', {command: 'restart'});
        });
        
        captureBtn.addEventListener('click', function() {
            socket.emit('camera_control', {command: 'capture'});
        });
        
        // Configuration form event handlers
        framerateSlider.addEventListener('input', function() {
            framerateValue.textContent = this.value;
        });
        
        brightnessSlider.addEventListener('input', function() {
            brightnessValue.textContent = this.value;
        });
        
        contrastSlider.addEventListener('input', function() {
            contrastValue.textContent = this.value;
        });
        
        saturationSlider.addEventListener('input', function() {
            saturationValue.textContent = this.value;
        });
        
        configForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(configForm);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'resolution') {
                    // Parse resolution string
                    const match = value.match(/\((\d+),\s*(\d+)\)/);
                    if (match) {
                        config.resolution = [parseInt(match[1]), parseInt(match[2])];
                    }
                } else if (['framerate', 'brightness', 'contrast', 'saturation'].includes(key)) {
                    config[key] = parseFloat(value);
                } else {
                    config[key] = value;
                }
            }
            
            socket.emit('camera_config_update', {config: config});
        });
        
        // Video feed error handling
        videoFeed.addEventListener('error', function() {
            addLog('Video feed error - camera may be offline', 'error');
        });
        
        videoFeed.addEventListener('load', function() {
            addLog('Video feed loaded successfully', 'success');
        });
        
        // Initial load
        addLog('Camera dashboard loaded', 'info');
        
        // Request initial status
        setTimeout(() => {
            socket.emit('camera_status_request');
        }, 1000);
    </script>
</body>
</html>
